<link rel="import" href="imports.html">
<dom-module id="my-weather" name="my-weather">
<template>
	<link rel="stylesheet" type="text/css" href="all.css">
	<iron-ajax
	    auto
	    id="weather"
	    url="http://api.openweathermap.org/data/2.5/forecast"
	    params='{{param}}'
	    handle-as="json"
	    on-response="handleResponse" 
	    last-response="{{ajaxResponse}}">
	</iron-ajax>
	<h2>Weather Forecast</h2>
	<div class="mainheader">
		<paper-material elevation="1" class="intro" animated="true">
			<div class="header">
				<paper-input label="State name" id="stateName" auto-validate="true" invalid$="{{inval}}" error-message="Invalid input!"></paper-input>
			  	<paper-button raised on-click="newAjax" id="butName">Submit</paper-button>
			</div>
			<div class="pardiv">
				<div class="parent">
					<span class="con">{{ajaxResponse.city.name}}</span>,
			  		<span class="city">{{ajaxResponse.city.country}}</span>
			  		<div class="parsub">
			  			<div hidden$="{{hide}}">{{calTemp(ajaxResponse.list.0.main.temp)}}</div>
			  			<div hidden$="{{show}}">{{ajaxResponse.list.0.main.temp}}</div>
			  			<button on-click="tempButton" hidden$="{{hide}}">°C</button>
			  			<button on-click="tempButton"  hidden$="{{show}}">°F</button>
			  		</div>
				</div>
				<div class="parimg">
					<span class="des">{{ajaxResponse.list.0.weather.0.description}}</span>
		  			<img class="headimg" src$="{{imgUrl(ajaxResponse.list.0.weather.0.icon)}}">
		  		</div>
	  		</div>
		</paper-material>

		<google-map latitude$="{{ajaxResponse.city.coord.lat}}" longitude$="{{ajaxResponse.city.coord.lon}}">
		  <template is="dom-repeat" items="[[ajaxResponse.list.0.weather]]">
			  <google-map-marker latitude$="{{ajaxResponse.city.coord.lat}}" longitude$="{{ajaxResponse.city.coord.lon}}" draggable="true" title$="{{ajaxResponse.city.name}}" icon$="{{imgUrl(item.icon)}}">
			  	<span>
			  		MaxTemp - <span>{{calTemp(ajaxResponse.list.0.main.temp_max)}}</span>,
			  		MinTemp - <span>{{calTemp(ajaxResponse.list.0.main.temp_min)}}</span>
			  	</span>
			  </google-map-marker>
		  </template>
		</google-map>
	</div>
	<div class="children">
		<template is="dom-repeat" items="[[ajaxResponse.list]]"  filter="isToday">
			<div class="chid-par">
			<ul class="child-div">
				<li class="ctime">
					<h3>{{item.dt_txt}}</h3>
				</li>
				<template is="dom-repeat" items="[[item.weather]]">
				<li class="cweather">
					<span class$="{{getIconClass(item.icon)}}">{{item.icon}}</span>
					<span>{{item.description}}</span>
				</li>
				</template>
				<li>
					<span class="chead">Temperature</span>
					<div><span>{{calTemp(item.main.temp)}}</span><span>°C</span></div>
				</li>
				<li>
					<span class="chead">Minimum Temperature</span>
					<div><span>{{calTemp(item.main.temp_min)}}</span><span>°C</span></div>
				</li>
				<li>
					<span class="chead">Maximum Temperature</span>
					<div><span>{{calTemp(item.main.temp_max)}}</span><span>°C</span></div>
				</li>
				<li>
					<span class="chead">Pressure</span>
					<div>{{item.main.pressure}}</div>
				</li>
				<li>
					<span class="chead">Wind</span>
					<div>{{item.wind.speed}}</div>
				</li>
			</ul>		
			</div>
		</template>
	</div>
	<div>
		<div hidden$="{{nhide}}" class="seeNext" on-click="isTomorrow">
			<span>See Next 24HR</span>	
			<paper-icon-button icon="arrow-forward"></paper-icon-button>
		</div>
		<div hidden$="{{phide}}" on-click="isYesterday" class="seeNext prev">	
			<paper-icon-button icon="arrow-back"></paper-icon-button>
			<span>Go Back</span>
		</div>
	</div>
	<paper-toolbar>
	  <paper-icon-button icon="menu" on-tap="menuAction"></paper-icon-button>
	  <div class="title">Title</div>
	  <paper-icon-button icon="more-vert" on-tap="moreAction"></paper-icon-button>
	</paper-toolbar>
</template>	
<script>
	Polymer({
      is: 'my-weather',
      ready:function(){
      	this.date=this.todayIs();
      	this.phide=true;
      },
      properties:{
      	param:{
      		type:Object,
      		value:function(){
      			return {
      				"q":"Hyderabad",
	      			"mode":"json"
      			}
      		},
      		notify:true
      	},
      	date:{
      		type:String,
      		notify: true
      	},
      	nhide:{
      		value:false
      	},
      	flag:{
      		value:1
      	},
      	timestp:{
      		value:0
      	},
      	show:{
      		value:true
      	},
      	hide:{
      		value:false
      	},
      	inval:{
      		value:false
      	}
      },	
      tempButton:function(){
      	this.show=!this.show;
      	this.hide=!this.hide; 
      },
      isToday: function(item) {
		var x=item.dt_txt.split(" ");
			y=this.date;
			return	x[0] == y;
	  },
	  isYesterday:function(){
	  	var today = new Date(),
	        dd = today.getDate(),
	    	mm = today.getMonth()+1,
	    	yyyy = today.getFullYear();
		    if(dd<10){dd='0'+dd} 
		    if(mm<10){mm='0'+mm} 
	    	today = yyyy+'-'+mm+'-'+dd;
			this.date=today;
			document.getElementById("weather").generateRequest();
			this.nhide=false;
			this.phide=true;
			this.flag=1;
	  },
	  todayIs:function(){
	  	var today = new Date(),
	        dd = today.getDate(),
	    	mm = today.getMonth()+1,
	    	yyyy = today.getFullYear();
		    if(dd<10){dd='0'+dd} 
		    if(mm<10){mm='0'+mm} 
	    	today = yyyy+'-'+mm+'-'+dd;
	    	return today;	
	  },
	  isTomorrow:function(){
	  	console.log(this.flag);
	  	if(this.flag == 6){this.nhide=true;return false;}
  		var currentDate = new Date(new Date().getTime() + 24 * 60 * 60 * 1000 * this.flag),
			dd = currentDate.getDate(),
			mm = currentDate.getMonth() + 1,
			yy = currentDate.getFullYear();
			this.timestp=currentDate;
			if(dd<10){dd='0'+dd} 
		    if(mm<10){mm='0'+mm} 
		    tomorrow = yy+"-"+mm+"-"+dd;
			this.date=tomorrow;
			document.getElementById("weather").generateRequest();
			this.phide=false;
			this.flag=this.flag+1;
	  },
      calTemp:function(x){
      	return (x-273).toFixed(2);
      },
      imgUrl:function(x){
      	return "http://openweathermap.com/img/w/"+x+".png";
      },
      newAjax:function(){
      	var item = this.$.stateName.value;
      	if(item){
      		this.param={"q":item,"mode":"json"};
      		document.getElementById("weather").generateRequest();
      	}else{
      		this.inval=true;
      	} 	
      },
	  timeStmpToTime:function(x){
		var d = new Date(x * 1000),	
			yyyy = d.getFullYear(),
			mm = ('0' + (d.getMonth() + 1)).slice(-2),
			dd = ('0' + d.getDate()).slice(-2);
			time = yyyy  + '-' + mm + '-' + dd;
			return time;			
      },
      handleResponse:function(data){
      	console.log(this.ajaxResponse);
      },
      getIconClass:function(iconName){
      	return 'icon icon-'+iconName;
      }
    });
</script>
</dom-module>	